{% extends "base.html" %}

{% block title %}{{ post.title }} - 博客系统{% endblock %}

{% block content %}
<article>
    <h1>{{ post.title }}</h1>
    <p class="text-muted">
        作者: {{ post.author.username }} | 
        发布时间: {{ post.created_at.strftime('%Y-%m-%d %H:%M') }} | 
        更新时间: {{ post.updated_at.strftime('%Y-%m-%d %H:%M') }} | 
        浏览: {{ post.view_count }}
        {% if post.category %}
        | 分类: <a href="{{ url_for('blog.index', category=post.category_id) }}">{{ post.category.name }}</a>
        {% endif %}
    </p>
    <div class="mb-3">
        {% for tag in post.tags %}
        <a href="{{ url_for('blog.index', tag=tag.id) }}" class="badge bg-secondary">{{ tag.name }}</a>
        {% endfor %}
    </div>

    {% if current_user.is_authenticated and (current_user.id == post.author_id or current_user.is_admin) %}
    <div class="mb-3">
        <a href="{{ url_for('blog.post_edit', id=post.id) }}" class="btn btn-sm btn-warning">编辑</a>
        <form method="POST" action="{{ url_for('blog.post_delete', id=post.id) }}" style="display: inline;">
            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('确定要删除这篇文章吗？')">删除</button>
        </form>
    </div>
    {% endif %}

    <hr>
    <div class="post-content">
        {{ post.content|markdown|safe }}
    </div>
</article>

<hr>
<section id="comments">
    <h3>评论 ({{ comments|length }})</h3>
    
    {% if current_user.is_authenticated %}
    <div class="card mb-4">
        <div class="card-body">
            <form method="POST" action="{{ url_for('comment.comment_create', post_id=post.id) }}">
                <div class="mb-3">
                    <textarea name="content" class="form-control" rows="3" placeholder="写下您的评论..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">发表评论</button>
            </form>
        </div>
    </div>
    {% else %}
    <p class="text-muted"><a href="{{ url_for('auth.login') }}">登录</a>后发表评论</p>
    {% endif %}

    {% for comment in comments %}
    <div class="card mb-3" id="comment-{{ comment.id }}">
        <div class="card-body">
            <h6>{{ comment.author.username }} <small class="text-muted">{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}</small></h6>
            <p>{{ comment.content }}</p>
            {% if current_user.is_authenticated %}
            <div>
                <button class="btn btn-sm btn-link reply-btn" data-comment-id="{{ comment.id }}">回复</button>
                {% if current_user.id == comment.user_id or current_user.is_admin %}
                <form method="POST" action="{{ url_for('comment.comment_delete', id=comment.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-sm btn-link text-danger" onclick="return confirm('确定要删除这条评论吗？')">删除</button>
                </form>
                {% endif %}
            </div>
            
            <div class="reply-form mt-3" id="reply-form-{{ comment.id }}" style="display: none;">
                <form method="POST" action="{{ url_for('comment.comment_create', post_id=post.id) }}">
                    <input type="hidden" name="parent_id" value="{{ comment.id }}">
                    <div class="mb-2">
                        <textarea name="content" class="form-control" rows="2" placeholder="回复..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-sm btn-primary">提交回复</button>
                    <button type="button" class="btn btn-sm btn-secondary cancel-reply">取消</button>
                </form>
            </div>
            {% endif %}

            {% for reply in comment.replies %}
            <div class="ms-4 mt-2 border-start ps-3">
                <h6>{{ reply.author.username }} <small class="text-muted">{{ reply.created_at.strftime('%Y-%m-%d %H:%M') }}</small></h6>
                <p>{{ reply.content }}</p>
                {% if current_user.is_authenticated and (current_user.id == reply.user_id or current_user.is_admin) %}
                <form method="POST" action="{{ url_for('comment.comment_delete', id=reply.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-sm btn-link text-danger" onclick="return confirm('确定要删除这条回复吗？')">删除</button>
                </form>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</section>
{% endblock %}

{% block scripts %}
<script>
document.querySelectorAll('.reply-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const commentId = this.dataset.commentId;
        const replyForm = document.getElementById('reply-form-' + commentId);
        replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
    });
});

document.querySelectorAll('.cancel-reply').forEach(btn => {
    btn.addEventListener('click', function() {
        this.closest('.reply-form').style.display = 'none';
    });
});
</script>
{% endblock %}
