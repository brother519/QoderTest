generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Url {
  id          String    @id @default(uuid())
  shortCode   String    @map("short_code")
  longUrl     String    @map("long_url")
  customCode  String?   @map("custom_code")
  domainId    String?   @map("domain_id")
  userId      String    @map("user_id")
  title       String?
  qrCodePath  String?   @map("qr_code_path")
  isActive    Boolean   @default(true) @map("is_active")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  domain         CustomDomain?   @relation(fields: [domainId], references: [id])
  clicks         Click[]
  analyticsDaily AnalyticsDaily[]

  @@unique([shortCode, domainId])
  @@index([userId])
  @@index([createdAt])
  @@index([longUrl])
  @@map("urls")
}

model Click {
  id         String   @id @default(uuid())
  urlId      String   @map("url_id")
  clickedAt  DateTime @default(now()) @map("clicked_at")
  ipHash     String?  @map("ip_hash")
  country    String?
  city       String?
  referrer   String?
  userAgent  String?  @map("user_agent")
  deviceType String?  @map("device_type")
  browser    String?
  os         String?

  url Url @relation(fields: [urlId], references: [id], onDelete: Cascade)

  @@index([urlId, clickedAt])
  @@index([clickedAt])
  @@index([referrer])
  @@map("clicks")
}

model AnalyticsDaily {
  id              String   @id @default(uuid())
  urlId           String   @map("url_id")
  date            DateTime @db.Date
  totalClicks     Int      @default(0) @map("total_clicks")
  uniqueIps       Int      @default(0) @map("unique_ips")
  topCountries    Json?    @map("top_countries")
  topReferrers    Json?    @map("top_referrers")
  deviceBreakdown Json?    @map("device_breakdown")
  createdAt       DateTime @default(now()) @map("created_at")

  url Url @relation(fields: [urlId], references: [id], onDelete: Cascade)

  @@unique([urlId, date])
  @@index([date])
  @@map("analytics_daily")
}

model ApiKey {
  id         String    @id @default(uuid())
  keyHash    String    @unique @map("key_hash")
  keyPrefix  String    @map("key_prefix")
  name       String
  userId     String    @map("user_id")
  scopes     Json      @default("[\"url:create\", \"url:read\", \"analytics:read\"]")
  rateLimit  Int       @default(1000) @map("rate_limit")
  lastUsedAt DateTime? @map("last_used_at")
  isActive   Boolean   @default(true) @map("is_active")
  createdAt  DateTime  @default(now()) @map("created_at")
  expiresAt  DateTime? @map("expires_at")

  @@index([userId, isActive])
  @@map("api_keys")
}

model CustomDomain {
  id                String   @id @default(uuid())
  domain            String   @unique
  userId            String   @map("user_id")
  isVerified        Boolean  @default(false) @map("is_verified")
  verificationToken String   @map("verification_token")
  sslEnabled        Boolean  @default(false) @map("ssl_enabled")
  createdAt         DateTime @default(now()) @map("created_at")

  urls Url[]

  @@map("custom_domains")
}
